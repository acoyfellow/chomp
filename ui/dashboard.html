<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>chomp</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:14px}
body{
  background:#fff;
  color:#111;
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
  line-height:1.5;
  min-height:100vh;
  padding:0;
}

/* ── Layout ── */
.wrap{max-width:960px;margin:0 auto;padding:2rem 1.5rem}

header{
  display:flex;align-items:baseline;justify-content:space-between;
  border-bottom:1px solid #e0e0e0;
  padding-bottom:.75rem;
  margin-bottom:1.5rem;
}
header h1{font-size:1.1rem;font-weight:600;letter-spacing:.02em}
header .meta{font-size:.75rem;color:#888}
header .meta .dot{display:inline-block;width:6px;height:6px;border-radius:50%;background:#4caf50;margin-right:4px;vertical-align:middle}

/* ── Section ── */
.section{margin-bottom:2rem}
.section-label{
  font-size:.7rem;
  font-weight:600;
  text-transform:uppercase;
  letter-spacing:.08em;
  color:#888;
  margin-bottom:.5rem;
}

/* ── Platforms table ── */
.plat-table{width:100%;border-collapse:collapse}
.plat-table th{
  text-align:left;
  font-size:.7rem;
  font-weight:500;
  text-transform:uppercase;
  letter-spacing:.06em;
  color:#999;
  padding:.35rem .5rem;
  border-bottom:1px solid #e0e0e0;
}
.plat-table td{
  padding:.5rem;
  border-bottom:1px solid #f0f0f0;
  font-size:.85rem;
  vertical-align:middle;
}
.plat-table tr:last-child td{border-bottom:none}
.plat-table tr.unavailable{opacity:.45}
.plat-table .name-cell{font-weight:500}
.plat-table .name-cell .icon{margin-right:.35rem}
.plat-table .num{font-variant-numeric:tabular-nums;text-align:right;white-space:nowrap}

/* bar */
.bar{display:flex;align-items:center;gap:.5rem;min-width:160px}
.bar-track{
  flex:1;height:6px;background:#f0f0f0;border-radius:3px;overflow:hidden;position:relative;
}
.bar-fill{
  height:100%;border-radius:3px;
  transition:width .4s ease;
}
.bar-fill.low{background:#111}
.bar-fill.mid{background:#e6a817}
.bar-fill.high{background:#d63031}
.bar-pct{font-size:.75rem;color:#666;min-width:2.5rem;text-align:right}

.tag{
  display:inline-block;
  font-size:.65rem;
  font-weight:500;
  padding:.1rem .4rem;
  border-radius:3px;
  text-transform:uppercase;
  letter-spacing:.04em;
}
.tag-ready{background:#e8f5e9;color:#2e7d32}
.tag-off{background:#f5f5f5;color:#999}
.tag-nokey{background:#fff3e0;color:#e65100}
.tag-err{background:#fce4ec;color:#c62828;cursor:help}

/* ── Add form ── */
.add-form{display:flex;flex-direction:column;gap:.5rem}
.add-form textarea{
  width:100%;
  min-height:60px;
  padding:.5rem .6rem;
  border:1px solid #ddd;
  border-radius:4px;
  font:inherit;
  font-size:.85rem;
  resize:vertical;
  background:#fafafa;
}
.add-form textarea:focus{outline:none;border-color:#888}
.add-row{display:flex;gap:.5rem;align-items:end}
.add-row .field{flex:1}
.add-row label{display:block;font-size:.7rem;color:#888;margin-bottom:.15rem;font-weight:500}
.add-row input,.add-row select{
  width:100%;padding:.35rem .5rem;
  border:1px solid #ddd;border-radius:4px;
  font:inherit;font-size:.8rem;
  background:#fafafa;
}
.add-row input:focus,.add-row select:focus{outline:none;border-color:#888}
.btn-add{
  padding:.4rem 1.2rem;
  background:#111;color:#fff;
  border:none;border-radius:4px;
  font:inherit;font-size:.8rem;font-weight:500;
  cursor:pointer;
  white-space:nowrap;
}
.btn-add:hover{background:#333}
.btn-add:disabled{opacity:.5;cursor:default}

/* ── Task lists ── */
.task-table{width:100%;border-collapse:collapse}
.task-table th{
  text-align:left;font-size:.7rem;font-weight:500;
  text-transform:uppercase;letter-spacing:.06em;color:#999;
  padding:.35rem .5rem;border-bottom:1px solid #e0e0e0;
}
.task-table td{
  padding:.45rem .5rem;
  border-bottom:1px solid #f0f0f0;
  font-size:.8rem;
  vertical-align:top;
}
.task-table tr:last-child td{border-bottom:none}
.task-prompt{max-width:400px}
.task-id{color:#888;font-variant-numeric:tabular-nums}
.task-status{
  display:inline-block;
  font-size:.65rem;
  font-weight:600;
  padding:.1rem .4rem;
  border-radius:3px;
  text-transform:uppercase;
  letter-spacing:.04em;
}
.status-active{background:#e3f2fd;color:#1565c0}
.status-queued{background:#f5f5f5;color:#666}
.status-done{background:#e8f5e9;color:#2e7d32}
.status-failed{background:#fce4ec;color:#c62828}

.task-actions{white-space:nowrap}
.btn-sm{
  padding:.2rem .5rem;font-size:.7rem;
  border:1px solid #ddd;border-radius:3px;
  background:#fff;cursor:pointer;font-family:inherit;
  color:#555;
}
.btn-sm:hover{background:#f5f5f5;border-color:#bbb}
.btn-sm.run{border-color:#1565c0;color:#1565c0}
.btn-sm.run:hover{background:#e3f2fd}
.btn-sm.del{border-color:#c62828;color:#c62828}
.btn-sm.del:hover{background:#fce4ec}

/* ── Stats bar ── */
.stats{
  display:flex;gap:1.5rem;
  font-size:.75rem;color:#888;
  padding:.5rem 0;
  border-top:1px solid #f0f0f0;
  margin-top:1rem;
}
.stats .s-val{font-weight:600;color:#111;margin-right:.2rem}

/* ── Completed toggle ── */
.done-toggle{
  font-size:.75rem;color:#888;cursor:pointer;
  border:none;background:none;font-family:inherit;
  padding:0;text-decoration:underline;
  text-underline-offset:2px;
}
.done-toggle:hover{color:#555}
.done-list{display:none}
.done-list.open{display:block}
.result-text{
  font-size:.75rem;color:#555;
  background:#fafafa;padding:.3rem .5rem;
  border-radius:3px;margin-top:.2rem;
  border:1px solid #f0f0f0;
  max-height:80px;overflow:auto;
  white-space:pre-wrap;
}

/* ── Empty ── */
.empty{text-align:center;padding:2rem;color:#aaa;font-size:.85rem}

/* ── Responsive ── */
@media(max-width:640px){
  .wrap{padding:1rem}
  .add-row{flex-direction:column}
  .plat-table,.task-table{display:block;overflow-x:auto}
}
</style>
</head>
<body>
<div class="wrap">

<header>
  <h1>chomp</h1>
  <div class="meta"><span class="dot" id="pip"></span>live</div>
</header>

<!-- ═══ PLATFORMS ═══ -->
<div class="section">
  <div class="section-label">Token Budgets</div>
  {{if .Platforms}}
  <table class="plat-table" id="platforms">
    <thead>
      <tr>
        <th>Platform</th>
        <th>Usage</th>
        <th class="num">Used</th>
        <th class="num">Budget</th>
        <th class="num">Remaining</th>
        <th>Resets</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      {{range .Platforms}}
      <tr class="{{if not .Available}}unavailable{{end}}" data-slug="{{.Slug}}">
        <td class="name-cell"><span class="icon">{{.Icon}}</span>{{.Name}}</td>
        <td>
          <div class="bar">
            <div class="bar-track">
              <div class="bar-fill" data-used="{{.TokensUsed}}" data-total="{{.TokensTotal}}" style="width:0%"></div>
            </div>
            <span class="bar-pct" data-pct></span>
          </div>
        </td>
        <td class="num" data-used-label>—</td>
        <td class="num" data-budget>{{.TokensTotal}}</td>
        <td class="num" data-remain-label>—</td>
        <td>{{.ResetsAt}}</td>
        <td>
          {{if .Available}}<span class="tag tag-ready">Ready</span>
          {{else if .LastError}}<span class="tag tag-err" title="{{.LastError}}">Error</span>
          {{else if not .HasKey}}<span class="tag tag-nokey">No Key</span>
          {{else}}<span class="tag tag-off">Off</span>
          {{end}}
        </td>
      </tr>
      {{end}}
    </tbody>
  </table>
  {{else}}
  <div class="empty">No platforms configured.</div>
  {{end}}
</div>

<!-- ═══ ADD TASK ═══ -->
<div class="section">
  <div class="section-label">New Task</div>
  <form class="add-form" id="addForm">
    <textarea name="prompt" placeholder="Describe the task…" required></textarea>
    <div class="add-row">
      <div class="field">
        <label>Directory (optional)</label>
        <input type="text" name="dir" placeholder="/path/to/project">
      </div>
      <div class="field">
        <label>Platform</label>
        <select name="platform">
          {{range .Platforms}}{{if .Available}}
          <option value="{{.Slug}}">{{.Name}}</option>
          {{end}}{{end}}
        </select>
      </div>
      <button type="submit" class="btn-add">Add Task</button>
    </div>
  </form>
</div>

<!-- ═══ ACTIVE + QUEUED ═══ -->
<div class="section">
  <div class="section-label">Tasks</div>
  {{if or .ActiveTasks .QueuedTasks}}
  <table class="task-table" id="taskTable">
    <thead>
      <tr>
        <th style="width:3rem">#</th>
        <th>Prompt</th>
        <th>Platform</th>
        <th>Dir</th>
        <th>Status</th>
        <th>Time</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {{range .ActiveTasks}}
      <tr>
        <td class="task-id">{{.ID}}</td>
        <td class="task-prompt">{{.Prompt}}</td>
        <td>{{.Platform}}</td>
        <td style="font-size:.75rem;color:#888">{{.Dir}}</td>
        <td><span class="task-status status-active">Active</span></td>
        <td style="font-size:.75rem;color:#888">{{.Elapsed}}</td>
        <td class="task-actions"></td>
      </tr>
      {{end}}
      {{range .QueuedTasks}}
      <tr>
        <td class="task-id">{{.ID}}</td>
        <td class="task-prompt">{{.Prompt}}</td>
        <td>{{.Platform}}</td>
        <td style="font-size:.75rem;color:#888">{{.Dir}}</td>
        <td><span class="task-status status-queued">Queued</span></td>
        <td style="font-size:.75rem;color:#888">{{.Created}}</td>
        <td class="task-actions">
          <button class="btn-sm run" onclick="runTask({{.ID}})">Run</button>
          <button class="btn-sm del" onclick="deleteTask({{.ID}})">Drop</button>
        </td>
      </tr>
      {{end}}
    </tbody>
  </table>
  {{else}}
  <div class="empty">No tasks. Add one above.</div>
  {{end}}
</div>

<!-- ═══ COMPLETED ═══ -->
<div class="section">
  {{if .DoneTasks}}
  <button class="done-toggle" id="doneToggle">Show {{len .DoneTasks}} completed task{{if gt (len .DoneTasks) 1}}s{{end}}</button>
  <div class="done-list" id="doneList">
    <table class="task-table" style="margin-top:.5rem">
      <thead>
        <tr>
          <th style="width:3rem">#</th>
          <th>Prompt</th>
          <th>Platform</th>
          <th class="num">Tokens</th>
          <th>Result</th>
        </tr>
      </thead>
      <tbody>
        {{range .DoneTasks}}
        <tr>
          <td class="task-id">{{.ID}}</td>
          <td class="task-prompt">{{.Prompt}}</td>
          <td>{{.Platform}}</td>
          <td class="num">{{.Tokens}}</td>
          <td>{{if .Result}}<div class="result-text">{{.Result}}</div>{{else}}—{{end}}</td>
        </tr>
        {{end}}
      </tbody>
    </table>
  </div>
  {{end}}
</div>

<!-- ═══ STATS ═══ -->
<div class="stats">
  <div><span class="s-val">{{.Stats.Queued}}</span>queued</div>
  <div><span class="s-val">{{.Stats.Active}}</span>active</div>
  <div><span class="s-val">{{.Stats.Done}}</span>done</div>
  <div><span class="s-val">{{.Stats.Failed}}</span>failed</div>
  <div><span class="s-val" id="totalTokens">{{.Stats.Tokens}}</span>tokens burned</div>
</div>

</div><!-- .wrap -->

<script>
(function(){
  /* ── format tokens ── */
  function fmt(n){
    n=parseInt(n,10)||0;
    if(n>=1e6) return (n/1e6).toFixed(1)+'M';
    if(n>=1e3) return Math.round(n/1e3)+'K';
    return ''+n;
  }

  /* ── init bars ── */
  function initBars(){
    document.querySelectorAll('.bar-fill').forEach(function(el){
      var used=parseInt(el.dataset.used,10)||0;
      var total=parseInt(el.dataset.total,10)||0;
      if(total===0){
        el.style.width='0%';
        var row=el.closest('tr');
        if(row){
          var p=row.querySelector('[data-pct]'); if(p) p.textContent='';
          var u=row.querySelector('[data-used-label]'); if(u) u.textContent='—';
          var r=row.querySelector('[data-remain-label]'); if(r) r.textContent='—';
          var b=row.querySelector('[data-budget]'); if(b) b.textContent='—';
        }
        return;
      }
      var pct=Math.min(100,(used/total)*100);
      var remain=total-used;

      el.classList.remove('low','mid','high');
      if(pct<50) el.classList.add('low');
      else if(pct<80) el.classList.add('mid');
      else el.classList.add('high');

      requestAnimationFrame(function(){el.style.width=pct+'%';});

      var row=el.closest('tr');
      if(!row) return;
      var pctEl=row.querySelector('[data-pct]');
      var usedEl=row.querySelector('[data-used-label]');
      var remEl=row.querySelector('[data-remain-label]');
      if(pctEl) pctEl.textContent=Math.round(pct)+'%';
      if(usedEl) usedEl.textContent=fmt(used);
      if(remEl) remEl.textContent=fmt(remain);
      var budEl=row.querySelector('[data-budget]');
      if(budEl) budEl.textContent=fmt(total);
    });
  }
  initBars();

  /* ── done toggle ── */
  var doneBtn=document.getElementById('doneToggle');
  var doneList=document.getElementById('doneList');
  if(doneBtn&&doneList){
    doneBtn.addEventListener('click',function(){
      var open=doneList.classList.toggle('open');
      doneBtn.textContent=open?'Hide completed':'Show '+doneList.querySelectorAll('tr').length+' completed tasks';
    });
  }

  /* ── form submit via API ── */
  var form=document.getElementById('addForm');
  if(form){
    form.addEventListener('submit',function(e){
      e.preventDefault();
      var btn=form.querySelector('.btn-add');
      var body={
        prompt:form.prompt.value,
        dir:form.dir.value,
        platform:form.platform?form.platform.value:''
      };
      btn.disabled=true;btn.textContent='Adding…';
      fetch('/api/tasks',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(body)
      }).then(function(r){
        if(!r.ok) throw new Error(r.status);
        form.prompt.value='';
        location.reload();
      }).catch(function(err){
        alert('Error: '+err.message);
      }).then(function(){
        btn.disabled=false;btn.textContent='Add Task';
      });
    });
  }

  /* ── task actions ── */
  window.runTask=function(id){
    fetch('/api/tasks/'+id+'/run',{method:'POST'})
      .then(function(){location.reload();})
      .catch(function(err){alert('Error: '+err.message);});
  };
  window.deleteTask=function(id){
    if(!confirm('Drop task #'+id+'?')) return;
    fetch('/api/tasks/'+id,{method:'DELETE'})
      .then(function(){location.reload();})
      .catch(function(err){alert('Error: '+err.message);});
  };

  /* ── auto-refresh ── */
  var pip=document.getElementById('pip');
  function refresh(){
    pip.style.background='#2196f3';
    fetch('/api/state',{credentials:'same-origin'})
      .then(function(r){return r.json();})
      .then(function(data){
        /* check if counts changed → reload */
        var sig=[
          (data.ActiveTasks||[]).length,
          (data.QueuedTasks||[]).length,
          (data.DoneTasks||[]).length,
          (data.Stats||{}).Failed||0
        ].join(',');
        if(window._sig&&window._sig!==sig){location.reload();return;}
        window._sig=sig;

        /* update bars in place */
        if(data.Platforms){
          data.Platforms.forEach(function(p){
            var row=document.querySelector('tr[data-slug="'+p.Slug+'"]');
            if(!row) return;
            var bar=row.querySelector('.bar-fill');
            if(bar){bar.dataset.used=p.TokensUsed;bar.dataset.total=p.TokensTotal;}
          });
          initBars();
        }
        var te=document.getElementById('totalTokens');
        if(te) te.textContent=data.Stats.Tokens;
      })
      .catch(function(){})
      .then(function(){pip.style.background='#4caf50';});
  }

  /* set initial sig */
  window._sig=[
    document.querySelectorAll('.status-active').length,
    document.querySelectorAll('.status-queued').length,
    {{len .DoneTasks}},
    {{.Stats.Failed}}
  ].join(',');

  setInterval(refresh,3000);
})();
</script>
</body>
</html>
