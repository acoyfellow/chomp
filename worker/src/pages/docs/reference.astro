---
import Layout from '../../layouts/Layout.astro'
import Nav from '../../components/Nav.astro'
import Code from '../../components/Code.astro'

const dispatchResp = `{"id": "m1a2b3c4", "model": "llama-3.3-70b-versatile", "router": "groq", "status": "running"}`
const errors = [
  { status: '400', body: '{"error":"prompt required"}', cause: 'Missing prompt field' },
  { status: '401', body: '{"error":"unauthorized"}', cause: 'Missing or invalid bearer token' },
  { status: '404', body: '{"error":"not found"}', cause: 'Job ID doesn\'t exist or expired (24h TTL)' },
  { status: '502', body: '{"error":"..."}', cause: 'Upstream model error (rate limit, provider down)' },
  { status: '503', body: '{"error":"API not configured"}', cause: 'Server missing CHOMP_API_TOKEN' },
]
---
<Layout
  title="API Reference"
  description="Complete API reference for chomp. Endpoints, parameters, response schemas, error codes."
  path="/docs/reference"
  keywords="API reference, endpoints, dispatch, models, authentication"
>
  <Nav active="/docs/reference" />
  <main class="max-w-4xl mx-auto px-6 py-16">
    <div class="text-sm font-semibold text-blue-500 mb-3">Reference</div>
    <h1 class="text-3xl font-bold tracking-tight mb-3">API Reference</h1>
    <p class="text-zinc-500 dark:text-zinc-400 mb-6">Base URL: <code class="bg-zinc-100 dark:bg-zinc-800 px-2 py-0.5 rounded text-sm">https://chomp.coey.dev</code></p>

    <div class="mb-10 p-5 rounded-xl border-l-4 border-gold bg-zinc-50 dark:bg-zinc-900 text-sm">
      <strong class="text-gold">BYO key.</strong> Chomp supports 7 routers: OpenCode Zen, Groq, Cerebras, SambaNova, Together, Fireworks, and OpenRouter. Configure your API keys via the <a href="/dashboard" class="underline text-blue-500">dashboard</a> or <code>POST /api/keys</code> to get a chomp token. All other endpoints (except <code>/api/models/free</code>) require <code>Authorization: Bearer &lt;token&gt;</code>.
    </div>

    <!-- POST /api/keys -->
    <section class="mb-14">
      <div class="flex items-center gap-2 mb-4">
        <span class="text-xs font-bold px-2 py-1 rounded bg-green-500/15 text-green-600 dark:text-green-400">POST</span>
        <code class="text-lg font-semibold">/api/keys</code>
      </div>
      <p class="text-zinc-600 dark:text-zinc-400 mb-5">Register your OpenRouter API key. Returns a chomp token for all subsequent requests. Key is validated against OpenRouter before storing.</p>

      <h3 class="text-sm font-bold uppercase tracking-wider text-zinc-400 mb-2">Request body (JSON)</h3>
      <div class="border border-zinc-200 dark:border-zinc-800 rounded-xl overflow-hidden mb-4">
        <table class="w-full text-sm">
          <thead><tr class="bg-zinc-50 dark:bg-zinc-900 text-zinc-500 text-xs uppercase tracking-wider"><th class="text-left px-4 py-3">Field</th><th class="text-left px-4 py-3">Type</th><th class="text-left px-4 py-3">Description</th></tr></thead>
          <tbody>
            <tr class="border-t border-zinc-100 dark:border-zinc-800"><td class="px-4 py-3 font-mono">openrouter_key</td><td class="px-4 py-3">string</td><td class="px-4 py-3">Your OpenRouter API key (starts with sk-or-). <span class="text-xs font-bold text-red-500 uppercase">Required</span></td></tr>
          </tbody>
        </table>
      </div>

      <h3 class="text-sm font-bold uppercase tracking-wider text-zinc-400 mb-2">Response 200</h3>
      <Code code={'{"token": "a1b2c3...", "created": "2026-02-14T12:00:00Z"}'} />
    </section>

    <section class="mb-14">
      <div class="flex items-center gap-2 mb-4">
        <span class="text-xs font-bold px-2 py-1 rounded bg-blue-500/15 text-blue-600 dark:text-blue-400">GET</span>
        <code class="text-lg font-semibold">/api/keys</code>
      </div>
      <p class="text-zinc-600 dark:text-zinc-400 mb-5">Check your key status. Returns a masked preview of your stored OpenRouter key.</p>
    </section>

    <section class="mb-14">
      <div class="flex items-center gap-2 mb-4">
        <span class="text-xs font-bold px-2 py-1 rounded bg-red-500/15 text-red-600 dark:text-red-400">DELETE</span>
        <code class="text-lg font-semibold">/api/keys</code>
      </div>
      <p class="text-zinc-600 dark:text-zinc-400 mb-5">Revoke your chomp token and delete your stored OpenRouter key.</p>
    </section>

    <!-- POST /api/dispatch -->
    <section class="mb-14">
      <div class="flex items-center gap-2 mb-4">
        <span class="text-xs font-bold px-2 py-1 rounded bg-green-500/15 text-green-600 dark:text-green-400">POST</span>
        <code class="text-lg font-semibold">/api/dispatch</code>
      </div>
      <p class="text-zinc-600 dark:text-zinc-400 mb-5">Send a prompt to a free model. Returns immediately with a job ID. The model processes asynchronously.</p>

      <h3 class="text-sm font-bold uppercase tracking-wider text-zinc-400 mb-2">Request body (JSON)</h3>
      <div class="border border-zinc-200 dark:border-zinc-800 rounded-xl overflow-hidden mb-4">
        <table class="w-full text-sm">
          <thead><tr class="bg-zinc-50 dark:bg-zinc-900 text-zinc-500 text-xs uppercase tracking-wider"><th class="text-left px-4 py-3">Field</th><th class="text-left px-4 py-3">Type</th><th class="text-left px-4 py-3">Description</th></tr></thead>
          <tbody>
            <tr class="border-t border-zinc-100 dark:border-zinc-800"><td class="px-4 py-3 font-mono">prompt</td><td class="px-4 py-3">string</td><td class="px-4 py-3">The prompt to send. <span class="text-xs font-bold text-red-500 uppercase">Required</span></td></tr>
            <tr class="border-t border-zinc-100 dark:border-zinc-800"><td class="px-4 py-3 font-mono">model</td><td class="px-4 py-3">string</td><td class="px-4 py-3">Model ID, or "auto" (default). Auto picks the free model with the largest context window.</td></tr>
            <tr class="border-t border-zinc-100 dark:border-zinc-800"><td class="px-4 py-3 font-mono">system</td><td class="px-4 py-3">string</td><td class="px-4 py-3">Optional system prompt prepended to the conversation.</td></tr>
            <tr class="border-t border-zinc-100 dark:border-zinc-800"><td class="px-4 py-3 font-mono">router</td><td class="px-4 py-3">string</td><td class="px-4 py-3">Router to use: <code>zen</code>, <code>groq</code>, <code>cerebras</code>, <code>sambanova</code>, <code>together</code>, <code>fireworks</code>, <code>openrouter</code>, or <code>auto</code> (default). Auto picks the first configured router.</td></tr>
          </tbody>
        </table>
      </div>

      <h3 class="text-sm font-bold uppercase tracking-wider text-zinc-400 mb-2">Response 200</h3>
      <Code code={dispatchResp} />
    </section>

    <!-- GET /api/result/:id -->
    <section class="mb-14">
      <div class="flex items-center gap-2 mb-4">
        <span class="text-xs font-bold px-2 py-1 rounded bg-blue-500/15 text-blue-600 dark:text-blue-400">GET</span>
        <code class="text-lg font-semibold">/api/result/:id</code>
      </div>
      <p class="text-zinc-600 dark:text-zinc-400 mb-5">Retrieve the status and result of a dispatched job.</p>

      <h3 class="text-sm font-bold uppercase tracking-wider text-zinc-400 mb-2">Path parameters</h3>
      <div class="border border-zinc-200 dark:border-zinc-800 rounded-xl overflow-hidden mb-4">
        <table class="w-full text-sm">
          <thead><tr class="bg-zinc-50 dark:bg-zinc-900 text-zinc-500 text-xs uppercase tracking-wider"><th class="text-left px-4 py-3">Param</th><th class="text-left px-4 py-3">Description</th></tr></thead>
          <tbody>
            <tr><td class="px-4 py-3 font-mono">id</td><td class="px-4 py-3">Job ID returned by /api/dispatch. <span class="text-xs font-bold text-red-500 uppercase">Required</span></td></tr>
          </tbody>
        </table>
      </div>

      <h3 class="text-sm font-bold uppercase tracking-wider text-zinc-400 mb-2">Response schema</h3>
      <div class="border border-zinc-200 dark:border-zinc-800 rounded-xl overflow-hidden mb-4">
        <table class="w-full text-sm">
          <thead><tr class="bg-zinc-50 dark:bg-zinc-900 text-zinc-500 text-xs uppercase tracking-wider"><th class="text-left px-4 py-3">Field</th><th class="text-left px-4 py-3">Type</th><th class="text-left px-4 py-3">Description</th></tr></thead>
          <tbody>
            <tr class="border-t border-zinc-100 dark:border-zinc-800"><td class="px-4 py-3 font-mono">id</td><td class="px-4 py-3">string</td><td class="px-4 py-3">Job ID</td></tr>
            <tr class="border-t border-zinc-100 dark:border-zinc-800"><td class="px-4 py-3 font-mono">status</td><td class="px-4 py-3">string</td><td class="px-4 py-3">running | done | error</td></tr>
            <tr class="border-t border-zinc-100 dark:border-zinc-800"><td class="px-4 py-3 font-mono">model</td><td class="px-4 py-3">string</td><td class="px-4 py-3">Model ID used</td></tr>
            <tr class="border-t border-zinc-100 dark:border-zinc-800"><td class="px-4 py-3 font-mono">router</td><td class="px-4 py-3">string</td><td class="px-4 py-3">Which router served this job</td></tr>
            <tr class="border-t border-zinc-100 dark:border-zinc-800"><td class="px-4 py-3 font-mono">prompt</td><td class="px-4 py-3">string</td><td class="px-4 py-3">Original prompt</td></tr>
            <tr class="border-t border-zinc-100 dark:border-zinc-800"><td class="px-4 py-3 font-mono">result</td><td class="px-4 py-3">string</td><td class="px-4 py-3">Model response (when done)</td></tr>
            <tr class="border-t border-zinc-100 dark:border-zinc-800"><td class="px-4 py-3 font-mono">error</td><td class="px-4 py-3">string</td><td class="px-4 py-3">Error message (when error)</td></tr>
            <tr class="border-t border-zinc-100 dark:border-zinc-800"><td class="px-4 py-3 font-mono">tokens_in</td><td class="px-4 py-3">number</td><td class="px-4 py-3">Prompt tokens consumed</td></tr>
            <tr class="border-t border-zinc-100 dark:border-zinc-800"><td class="px-4 py-3 font-mono">tokens_out</td><td class="px-4 py-3">number</td><td class="px-4 py-3">Completion tokens generated</td></tr>
            <tr class="border-t border-zinc-100 dark:border-zinc-800"><td class="px-4 py-3 font-mono">latency_ms</td><td class="px-4 py-3">number</td><td class="px-4 py-3">Processing time in milliseconds</td></tr>
            <tr class="border-t border-zinc-100 dark:border-zinc-800"><td class="px-4 py-3 font-mono">created</td><td class="px-4 py-3">string</td><td class="px-4 py-3">ISO 8601 timestamp</td></tr>
            <tr class="border-t border-zinc-100 dark:border-zinc-800"><td class="px-4 py-3 font-mono">finished</td><td class="px-4 py-3">string</td><td class="px-4 py-3">ISO 8601 timestamp (when complete)</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- GET /api/jobs -->
    <section class="mb-14">
      <div class="flex items-center gap-2 mb-4">
        <span class="text-xs font-bold px-2 py-1 rounded bg-blue-500/15 text-blue-600 dark:text-blue-400">GET</span>
        <code class="text-lg font-semibold">/api/jobs</code>
      </div>
      <p class="text-zinc-600 dark:text-zinc-400 mb-5">Returns the 50 most recent jobs, newest first. Same schema as /api/result/:id, wrapped in an array.</p>
    </section>

    <!-- GET /api/models/:router -->
    <section class="mb-14">
      <div class="flex items-center gap-2 mb-4">
        <span class="text-xs font-bold px-2 py-1 rounded bg-blue-500/15 text-blue-600 dark:text-blue-400">GET</span>
        <code class="text-lg font-semibold">/api/models/:router</code>
      </div>
      <p class="text-zinc-600 dark:text-zinc-400 mb-5">Returns available models for any router. Pass the router slug as the path parameter: <code>zen</code>, <code>groq</code>, <code>cerebras</code>, <code>sambanova</code>, <code>together</code>, <code>fireworks</code>, or <code>openrouter</code>.</p>

      <h3 class="text-sm font-bold uppercase tracking-wider text-zinc-400 mb-2">Response schema</h3>
      <div class="border border-zinc-200 dark:border-zinc-800 rounded-xl overflow-hidden mb-4">
        <table class="w-full text-sm">
          <thead><tr class="bg-zinc-50 dark:bg-zinc-900 text-zinc-500 text-xs uppercase tracking-wider"><th class="text-left px-4 py-3">Field</th><th class="text-left px-4 py-3">Type</th><th class="text-left px-4 py-3">Description</th></tr></thead>
          <tbody>
            <tr class="border-t border-zinc-100 dark:border-zinc-800"><td class="px-4 py-3 font-mono">router</td><td class="px-4 py-3">string</td><td class="px-4 py-3">Router slug that was queried</td></tr>
            <tr class="border-t border-zinc-100 dark:border-zinc-800"><td class="px-4 py-3 font-mono">count</td><td class="px-4 py-3">number</td><td class="px-4 py-3">Number of models available</td></tr>
            <tr class="border-t border-zinc-100 dark:border-zinc-800"><td class="px-4 py-3 font-mono">models</td><td class="px-4 py-3">array</td><td class="px-4 py-3">Array of model objects</td></tr>
            <tr class="border-t border-zinc-100 dark:border-zinc-800"><td class="px-4 py-3 font-mono">models[].id</td><td class="px-4 py-3">string</td><td class="px-4 py-3">Full model ID (pass to /api/dispatch)</td></tr>
            <tr class="border-t border-zinc-100 dark:border-zinc-800"><td class="px-4 py-3 font-mono">models[].name</td><td class="px-4 py-3">string</td><td class="px-4 py-3">Human-readable model name</td></tr>
            <tr class="border-t border-zinc-100 dark:border-zinc-800"><td class="px-4 py-3 font-mono">models[].context_length</td><td class="px-4 py-3">number</td><td class="px-4 py-3">Maximum context window in tokens</td></tr>
            <tr class="border-t border-zinc-100 dark:border-zinc-800"><td class="px-4 py-3 font-mono">models[].max_output</td><td class="px-4 py-3">number</td><td class="px-4 py-3">Maximum output tokens (0 if unknown)</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- GET /api/models/free -->
    <section class="mb-14">
      <div class="flex items-center gap-2 mb-4">
        <span class="text-xs font-bold px-2 py-1 rounded bg-blue-500/15 text-blue-600 dark:text-blue-400">GET</span>
        <code class="text-lg font-semibold">/api/models/free</code>
      </div>
      <p class="text-zinc-600 dark:text-zinc-400 mb-5">Returns currently available free models on OpenRouter specifically. <strong>No authentication required.</strong> Cached for 15 minutes. For other routers, use <code>/api/models/:router</code>.</p>

      <h3 class="text-sm font-bold uppercase tracking-wider text-zinc-400 mb-2">Response schema</h3>
      <div class="border border-zinc-200 dark:border-zinc-800 rounded-xl overflow-hidden mb-4">
        <table class="w-full text-sm">
          <thead><tr class="bg-zinc-50 dark:bg-zinc-900 text-zinc-500 text-xs uppercase tracking-wider"><th class="text-left px-4 py-3">Field</th><th class="text-left px-4 py-3">Type</th><th class="text-left px-4 py-3">Description</th></tr></thead>
          <tbody>
            <tr class="border-t border-zinc-100 dark:border-zinc-800"><td class="px-4 py-3 font-mono">count</td><td class="px-4 py-3">number</td><td class="px-4 py-3">Number of free models available</td></tr>
            <tr class="border-t border-zinc-100 dark:border-zinc-800"><td class="px-4 py-3 font-mono">models</td><td class="px-4 py-3">array</td><td class="px-4 py-3">Array of model objects</td></tr>
            <tr class="border-t border-zinc-100 dark:border-zinc-800"><td class="px-4 py-3 font-mono">models[].id</td><td class="px-4 py-3">string</td><td class="px-4 py-3">Full model ID (pass to /api/dispatch)</td></tr>
            <tr class="border-t border-zinc-100 dark:border-zinc-800"><td class="px-4 py-3 font-mono">models[].name</td><td class="px-4 py-3">string</td><td class="px-4 py-3">Human-readable model name</td></tr>
            <tr class="border-t border-zinc-100 dark:border-zinc-800"><td class="px-4 py-3 font-mono">models[].context_length</td><td class="px-4 py-3">number</td><td class="px-4 py-3">Maximum context window in tokens</td></tr>
            <tr class="border-t border-zinc-100 dark:border-zinc-800"><td class="px-4 py-3 font-mono">models[].max_output</td><td class="px-4 py-3">number</td><td class="px-4 py-3">Maximum output tokens (0 if unknown)</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Errors -->
    <section class="mb-14">
      <h2 class="text-xl font-bold tracking-tight mb-4 pb-3 border-b border-zinc-200 dark:border-zinc-800">Error codes</h2>
      <div class="border border-zinc-200 dark:border-zinc-800 rounded-xl overflow-hidden">
        <table class="w-full text-sm">
          <thead><tr class="bg-zinc-50 dark:bg-zinc-900 text-zinc-500 text-xs uppercase tracking-wider"><th class="text-left px-4 py-3">Status</th><th class="text-left px-4 py-3">Body</th><th class="text-left px-4 py-3">Cause</th></tr></thead>
          <tbody>
            {errors.map(e => (
              <tr class="border-t border-zinc-100 dark:border-zinc-800">
                <td class="px-4 py-3 font-mono">{e.status}</td>
                <td class="px-4 py-3 font-mono text-xs">{e.body}</td>
                <td class="px-4 py-3">{e.cause}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </section>
  </main>
</Layout>
