{{define "content"}}
<div class="max-w-[600px] mx-auto flex flex-col min-h-dvh">

  <!-- Topbar -->
  <div class="flex items-center px-4 pt-3 pb-1 gap-2">
    <div class="flex-1 text-lg font-bold tracking-tight">chomp<span class="text-gold">.</span></div>
    <button onclick="openSheet('settings-dialog')" class="w-9 h-9 rounded-full border border-zinc-200 dark:border-zinc-700 bg-zinc-50 dark:bg-zinc-900 flex items-center justify-center text-zinc-400 text-sm cursor-pointer hover:border-zinc-300 active:scale-90 transition-all">⚙</button>
    <button onclick="toggleTheme()" id="theme-toggle" class="w-9 h-9 rounded-full border border-zinc-200 dark:border-zinc-700 bg-zinc-50 dark:bg-zinc-900 flex items-center justify-center text-zinc-400 text-sm cursor-pointer hover:border-zinc-300 active:scale-90 transition-all">☾</button>
  </div>

  <!-- Balance card -->
  <div hx-get="/partials/balance" hx-trigger="load, every 60s" hx-swap="innerHTML" 
       class="mx-4 mt-3 mb-3 p-5 bg-zinc-900 dark:bg-zinc-800 dark:border dark:border-zinc-700 text-white rounded-2xl cursor-pointer shadow-lg active:scale-[0.98] transition-transform"
       onclick="openSheet('settings-dialog')">
    <div class="text-[11px] uppercase tracking-widest opacity-50 font-semibold">Loading...</div>
  </div>

  <!-- Tabs -->
  <div class="flex gap-1 px-4 py-2 shrink-0" id="tab-bar">
    <button class="flex-1 py-2.5 rounded-xl text-sm font-medium cursor-pointer transition-all bg-zinc-900 text-white dark:bg-zinc-200 dark:text-zinc-900 shadow-sm"
            hx-get="/partials/tasks?tab=active" hx-target="#content" hx-swap="innerHTML"
            onclick="setTab(this)">Active</button>
    <button class="flex-1 py-2.5 rounded-xl text-sm font-medium cursor-pointer transition-all bg-zinc-100 text-zinc-400 dark:bg-zinc-800 dark:text-zinc-500"
            hx-get="/partials/tasks?tab=completed" hx-target="#content" hx-swap="innerHTML"
            onclick="setTab(this)">Completed</button>
  </div>

  <!-- Content -->
  <div id="content" class="flex-1 px-4 pb-4 overflow-y-auto"
       hx-get="/partials/tasks?tab=active" hx-trigger="load, every 3s, refreshTasks from:body" hx-swap="innerHTML">
  </div>

  <!-- New task button -->
  <div class="px-4 pb-4 shrink-0">
    <button onclick="openSheet('create-dialog')" class="w-full py-3.5 rounded-xl border border-zinc-200 dark:border-zinc-700 bg-zinc-50 dark:bg-zinc-900 text-zinc-900 dark:text-zinc-100 text-[15px] font-semibold cursor-pointer hover:border-zinc-300 active:scale-[0.98] transition-all">+ New Task</button>
  </div>

</div>

<!-- Task detail sheet -->
<div id="detail-backdrop" class="sheet-backdrop" onclick="closeSheet('detail-dialog')"></div>
<div id="detail-dialog" class="sheet-panel">
  <div class="w-9 h-1 bg-zinc-300 dark:bg-zinc-600 rounded-full mx-auto mt-2.5"></div>
  <div id="detail-body" class="p-5 pb-8"></div>
</div>

<!-- Settings sheet -->
<div id="settings-backdrop" class="sheet-backdrop" onclick="closeSheet('settings-dialog')"></div>
<div id="settings-dialog" class="sheet-panel">
  <div class="w-9 h-1 bg-zinc-300 dark:bg-zinc-600 rounded-full mx-auto mt-2.5"></div>
  <div id="settings-body" class="p-5 pb-8" hx-get="/partials/settings" hx-trigger="open-settings from:body" hx-swap="innerHTML">
    <div class="text-xl font-bold">Loading...</div>
  </div>
</div>

<!-- Create task sheet -->
<div id="create-backdrop" class="sheet-backdrop" onclick="closeSheet('create-dialog')"></div>
<div id="create-dialog" class="sheet-panel">
  <div class="w-9 h-1 bg-zinc-300 dark:bg-zinc-600 rounded-full mx-auto mt-2.5"></div>
  <div id="create-body" class="p-5 pb-8" hx-get="/partials/create" hx-trigger="open-create from:body" hx-swap="innerHTML">
  </div>
</div>

<!-- Toast -->
<div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 -translate-y-5 bg-zinc-900 dark:bg-zinc-100 text-white dark:text-zinc-900 px-5 py-2.5 rounded-xl text-sm font-medium z-[500] opacity-0 transition-all shadow-lg max-w-[90vw] text-center pointer-events-none"></div>

<script>
let currentTab = 'active';

function setTab(el) {
  const btns = document.querySelectorAll('#tab-bar button');
  btns.forEach(b => {
    b.className = 'flex-1 py-2.5 rounded-xl text-sm font-medium cursor-pointer transition-all bg-zinc-100 text-zinc-400 dark:bg-zinc-800 dark:text-zinc-500';
  });
  el.className = 'flex-1 py-2.5 rounded-xl text-sm font-medium cursor-pointer transition-all bg-zinc-900 text-white dark:bg-zinc-200 dark:text-zinc-900 shadow-sm';
  const url = new URL(el.getAttribute('hx-get'), location.href);
  currentTab = url.searchParams.get('tab');
  // Update polling target
  document.getElementById('content').setAttribute('hx-get', '/partials/tasks?tab=' + currentTab);
}

function openSheet(id) {
  const panel = document.getElementById(id);
  const backdrop = document.getElementById(id.replace('dialog','backdrop'));
  if (panel) panel.classList.add('open');
  if (backdrop) backdrop.classList.add('open');
  if (id === 'settings-dialog') htmx.trigger(document.body, 'open-settings');
  if (id === 'create-dialog') htmx.trigger(document.body, 'open-create');
}

function closeSheet(id) {
  const panel = document.getElementById(id);
  const backdrop = document.getElementById(id.replace('dialog','backdrop'));
  if (panel) panel.classList.remove('open');
  if (backdrop) backdrop.classList.remove('open');
}

function closeAllSheets() {
  document.querySelectorAll('.sheet-panel').forEach(p => p.classList.remove('open'));
  document.querySelectorAll('.sheet-backdrop').forEach(b => b.classList.remove('open'));
}

function openDetail(taskId) {
  htmx.ajax('GET', '/partials/detail/' + taskId, '#detail-body');
  openSheet('detail-dialog');
}

document.addEventListener('keydown', e => { if (e.key === 'Escape') closeAllSheets(); });

function showToast(msg, isErr) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'fixed top-4 left-1/2 -translate-x-1/2 translate-y-0 px-5 py-2.5 rounded-xl text-sm font-medium z-[500] opacity-100 transition-all shadow-lg max-w-[90vw] text-center pointer-events-none ' + (isErr ? 'bg-red-600 text-white' : 'bg-zinc-900 dark:bg-zinc-100 text-white dark:text-zinc-900');
  setTimeout(() => { t.className = t.className.replace('opacity-100','opacity-0').replace('translate-y-0','-translate-y-5'); }, 3000);
}

function toggleTheme() {
  document.documentElement.classList.toggle('dark');
  localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
  const btn = document.getElementById('theme-toggle');
  btn.textContent = document.documentElement.classList.contains('dark') ? '\u2600' : '\u263e';
}
(function(){
  if (localStorage.getItem('theme') === 'dark') {
    document.documentElement.classList.add('dark');
    document.getElementById('theme-toggle').textContent = '\u2600';
  }
})();

// Listen for HTMX events for toasts
document.body.addEventListener('showToast', function(e) {
  showToast(e.detail.message, e.detail.error);
});
</script>
{{end}}
