#!/usr/bin/env bash
# run-agent - dispatch to the right AI agent CLI
# Usage: run-agent <agent> <model> <prompt>
# Env: CHOMP_API, TASK_ID, REPO_DIR (optional)
# Gate: If REPO_DIR/gates/health.sh exists, run it after agent completes.
#       Pass → chomp done. Fail → re-run agent with gate output (up to MAX_GATE_LOOPS).
set -euo pipefail

AGENT="${1:?agent required}"
MODEL="${2:?model required}"
PROMPT="${3:?prompt required}"
WORKDIR="${REPO_DIR:-/workspace}"
MAX_GATE_LOOPS="${MAX_GATE_LOOPS:-3}"

export AGENT MODEL

echo "[chomp] Starting agent=$AGENT model=$MODEL"
echo "[chomp] Working dir=$WORKDIR"
echo "[chomp] Prompt: $PROMPT"
echo "---"

run_agent() {
  local prompt="$1"
  local exit_code=0

  case "$AGENT" in
    pi)
      cd "$WORKDIR"
      if [ -n "${ANTHROPIC_API_KEY:-}" ]; then export ANTHROPIC_API_KEY; fi
      if [ -n "${OPENAI_API_KEY:-}" ]; then export OPENAI_API_KEY; fi
      pi --message "$prompt" --dir "$WORKDIR" 2>&1 || exit_code=$?
      ;;
    opencode)
      cd "$WORKDIR"
      opencode run --message "$prompt" 2>&1 || exit_code=$?
      ;;
    shelley)
      echo "[chomp] Shelley adapter not yet available in sandbox"
      exit_code=1
      ;;
    *)
      echo "[chomp] Unknown agent: $AGENT"
      exit_code=1
      ;;
  esac

  return $exit_code
}

run_gate() {
  local gate_file="$WORKDIR/gates/health.sh"
  if [ ! -f "$gate_file" ]; then
    echo "[chomp] No gate file at $gate_file — skipping verification"
    return 0
  fi

  echo "[chomp] Running gate: $gate_file"
  local gate_output
  gate_output=$(bash "$gate_file" 2>&1) || {
    echo "[chomp] Gate FAILED:"
    echo "$gate_output"
    # Return failure and store output
    GATE_OUTPUT="$gate_output"
    return 1
  }
  echo "[chomp] Gate PASSED"
  echo "$gate_output"
  return 0
}

# Main loop: run agent, then verify with gate
LOOP=0
CURRENT_PROMPT="$PROMPT"

while true; do
  LOOP=$((LOOP + 1))
  echo "[chomp] === Attempt $LOOP/$MAX_GATE_LOOPS ==="

  run_agent "$CURRENT_PROMPT"
  AGENT_EXIT=$?

  if [ "$AGENT_EXIT" -ne 0 ]; then
    echo "---"
    echo "[chomp] Agent exited with code $AGENT_EXIT"
    chomp fail "Agent $AGENT failed with exit code $AGENT_EXIT"
    exit 1
  fi

  echo "---"
  echo "[chomp] Agent finished, checking gate..."

  GATE_OUTPUT=""
  if run_gate; then
    echo "[chomp] All gates passed! Task complete."
    chomp done "Agent $AGENT completed. Gates passed."
    exit 0
  fi

  # Gate failed
  if [ "$LOOP" -ge "$MAX_GATE_LOOPS" ]; then
    echo "[chomp] Max gate loops ($MAX_GATE_LOOPS) reached. Marking failed."
    chomp fail "Agent $AGENT: gates failed after $MAX_GATE_LOOPS attempts. Last output: $GATE_OUTPUT"
    exit 1
  fi

  echo "[chomp] Gate failed, re-running agent with gate output..."
  CURRENT_PROMPT="The previous attempt failed gate verification. Fix these issues and try again:\n\n$GATE_OUTPUT\n\nOriginal task: $PROMPT"
  chomp update 0  # ping to show activity
done
